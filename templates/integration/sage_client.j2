"""
SAGE API Client for {{ project_name }}
Handles authentication and data extraction from SAGE 50/100/200/X3

Generated by IntegrationAgent
"""

import os
import logging
from typing import Dict, List, Any, Optional
from datetime import datetime, timedelta
import requests
from requests.auth import HTTPBasicAuth


class SAGEClient:
    """
    Client for SAGE accounting software API.
    Supports SAGE 50 (US/UK), SAGE 100, SAGE 200, and SAGE X3.
    """
    
    def __init__(self, base_url: Optional[str] = None, api_key: Optional[str] = None,
                 api_secret: Optional[str] = None, version: str = "50"):
        """
        Initialize SAGE API client.
        
        Args:
            base_url: SAGE API base URL
            api_key: API key or username
            api_secret: API secret or password
            version: SAGE version (50, 100, 200, X3)
        """
        self.logger = logging.getLogger(__name__)
        
        # Get from environment if not provided
        self.base_url = base_url or os.getenv('SAGE_BASE_URL', 'https://api.sage.com')
        self.api_key = api_key or os.getenv('SAGE_API_KEY')
        self.api_secret = api_secret or os.getenv('SAGE_API_SECRET')
        self.version = version or os.getenv('SAGE_VERSION', '50')
        
        if not self.api_key or not self.api_secret:
            raise ValueError("SAGE API credentials not provided")
        
        self.session = requests.Session()
        self.session.auth = HTTPBasicAuth(self.api_key, self.api_secret)
        self.session.headers.update({
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        })
        
        self.logger.info(f"SAGE {self.version} API client initialized")
    
    def _request(self, method: str, endpoint: str, **kwargs) -> Dict:
        """
        Make API request with error handling.
        
        Args:
            method: HTTP method
            endpoint: API endpoint
            **kwargs: Additional request parameters
            
        Returns:
            Response data
        """
        url = f"{self.base_url}/{endpoint}"
        
        try:
            response = self.session.request(method, url, **kwargs)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            self.logger.error(f"SAGE API request failed: {e}")
            raise
    
    # ===================================================================
    # CUSTOMER OPERATIONS
    # ===================================================================
    
    def get_customers(self, modified_since: Optional[datetime] = None,
                     limit: int = 100, offset: int = 0) -> List[Dict]:
        """
        Get customers from SAGE.
        
        Args:
            modified_since: Only get customers modified after this date
            limit: Maximum number of records
            offset: Offset for pagination
            
        Returns:
            List of customer dictionaries
        """
        params = {'limit': limit, 'offset': offset}
        
        if modified_since:
            params['modified_since'] = modified_since.isoformat()
        
        data = self._request('GET', 'customers', params=params)
        return data.get('data', [])
    
    def get_customer(self, customer_id: str) -> Dict:
        """Get single customer by ID."""
        data = self._request('GET', f'customers/{customer_id}')
        return data.get('data', {})
    
    # ===================================================================
    # SUPPLIER OPERATIONS
    # ===================================================================
    
    def get_suppliers(self, modified_since: Optional[datetime] = None,
                     limit: int = 100, offset: int = 0) -> List[Dict]:
        """
        Get suppliers/vendors from SAGE.
        
        Args:
            modified_since: Only get suppliers modified after this date
            limit: Maximum number of records
            offset: Offset for pagination
            
        Returns:
            List of supplier dictionaries
        """
        params = {'limit': limit, 'offset': offset}
        
        if modified_since:
            params['modified_since'] = modified_since.isoformat()
        
        data = self._request('GET', 'suppliers', params=params)
        return data.get('data', [])
    
    def get_supplier(self, supplier_id: str) -> Dict:
        """Get single supplier by ID."""
        data = self._request('GET', f'suppliers/{supplier_id}')
        return data.get('data', {})
    
    # ===================================================================
    # PRODUCT/INVENTORY OPERATIONS
    # ===================================================================
    
    def get_products(self, modified_since: Optional[datetime] = None,
                    limit: int = 100, offset: int = 0) -> List[Dict]:
        """
        Get products/stock items from SAGE.
        
        Args:
            modified_since: Only get products modified after this date
            limit: Maximum number of records
            offset: Offset for pagination
            
        Returns:
            List of product dictionaries
        """
        params = {'limit': limit, 'offset': offset}
        
        if modified_since:
            params['modified_since'] = modified_since.isoformat()
        
        data = self._request('GET', 'products', params=params)
        return data.get('data', [])
    
    def get_product(self, product_id: str) -> Dict:
        """Get single product by ID."""
        data = self._request('GET', f'products/{product_id}')
        return data.get('data', {})
    
    # ===================================================================
    # NOMINAL ACCOUNT (CHART OF ACCOUNTS) OPERATIONS
    # ===================================================================
    
    def get_nominal_accounts(self, limit: int = 100, offset: int = 0) -> List[Dict]:
        """
        Get nominal accounts (chart of accounts) from SAGE.
        
        Args:
            limit: Maximum number of records
            offset: Offset for pagination
            
        Returns:
            List of nominal account dictionaries
        """
        params = {'limit': limit, 'offset': offset}
        data = self._request('GET', 'nominal_accounts', params=params)
        return data.get('data', [])
    
    def get_nominal_account(self, account_id: str) -> Dict:
        """Get single nominal account by ID."""
        data = self._request('GET', f'nominal_accounts/{account_id}')
        return data.get('data', {})
    
    # ===================================================================
    # SALES INVOICE OPERATIONS
    # ===================================================================
    
    def get_sales_invoices(self, modified_since: Optional[datetime] = None,
                          from_date: Optional[datetime] = None,
                          to_date: Optional[datetime] = None,
                          limit: int = 100, offset: int = 0) -> List[Dict]:
        """
        Get sales invoices from SAGE.
        
        Args:
            modified_since: Only get invoices modified after this date
            from_date: Filter by invoice date (from)
            to_date: Filter by invoice date (to)
            limit: Maximum number of records
            offset: Offset for pagination
            
        Returns:
            List of sales invoice dictionaries
        """
        params = {'limit': limit, 'offset': offset}
        
        if modified_since:
            params['modified_since'] = modified_since.isoformat()
        if from_date:
            params['from_date'] = from_date.strftime('%Y-%m-%d')
        if to_date:
            params['to_date'] = to_date.strftime('%Y-%m-%d')
        
        data = self._request('GET', 'sales_invoices', params=params)
        return data.get('data', [])
    
    def get_sales_invoice(self, invoice_id: str) -> Dict:
        """Get single sales invoice by ID."""
        data = self._request('GET', f'sales_invoices/{invoice_id}')
        return data.get('data', {})
    
    # ===================================================================
    # PURCHASE INVOICE OPERATIONS
    # ===================================================================
    
    def get_purchase_invoices(self, modified_since: Optional[datetime] = None,
                             from_date: Optional[datetime] = None,
                             to_date: Optional[datetime] = None,
                             limit: int = 100, offset: int = 0) -> List[Dict]:
        """
        Get purchase invoices from SAGE.
        
        Args:
            modified_since: Only get invoices modified after this date
            from_date: Filter by invoice date (from)
            to_date: Filter by invoice date (to)
            limit: Maximum number of records
            offset: Offset for pagination
            
        Returns:
            List of purchase invoice dictionaries
        """
        params = {'limit': limit, 'offset': offset}
        
        if modified_since:
            params['modified_since'] = modified_since.isoformat()
        if from_date:
            params['from_date'] = from_date.strftime('%Y-%m-%d')
        if to_date:
            params['to_date'] = to_date.strftime('%Y-%m-%d')
        
        data = self._request('GET', 'purchase_invoices', params=params)
        return data.get('data', [])
    
    def get_purchase_invoice(self, invoice_id: str) -> Dict:
        """Get single purchase invoice by ID."""
        data = self._request('GET', f'purchase_invoices/{invoice_id}')
        return data.get('data', {})
    
    # ===================================================================
    # PAYMENT OPERATIONS
    # ===================================================================
    
    def get_payments(self, modified_since: Optional[datetime] = None,
                    from_date: Optional[datetime] = None,
                    to_date: Optional[datetime] = None,
                    limit: int = 100, offset: int = 0) -> List[Dict]:
        """
        Get payments from SAGE.
        
        Args:
            modified_since: Only get payments modified after this date
            from_date: Filter by payment date (from)
            to_date: Filter by payment date (to)
            limit: Maximum number of records
            offset: Offset for pagination
            
        Returns:
            List of payment dictionaries
        """
        params = {'limit': limit, 'offset': offset}
        
        if modified_since:
            params['modified_since'] = modified_since.isoformat()
        if from_date:
            params['from_date'] = from_date.strftime('%Y-%m-%d')
        if to_date:
            params['to_date'] = to_date.strftime('%Y-%m-%d')
        
        data = self._request('GET', 'payments', params=params)
        return data.get('data', [])
    
    # ===================================================================
    # BULK OPERATIONS
    # ===================================================================
    
    def extract_all_data(self, years_of_data: int = 1) -> Dict[str, List[Dict]]:
        """
        Extract all data from SAGE for migration.
        
        Args:
            years_of_data: Number of years of historical data to extract
            
        Returns:
            Dictionary with entity types as keys and lists of records as values
        """
        since_date = datetime.now() - timedelta(days=years_of_data * 365)
        
        self.logger.info(f"Extracting {years_of_data} years of SAGE data...")
        
        all_data = {
            'customers': self._extract_all_paged(self.get_customers, since_date),
            'suppliers': self._extract_all_paged(self.get_suppliers, since_date),
            'products': self._extract_all_paged(self.get_products, since_date),
            'nominal_accounts': self._extract_all_paged(self.get_nominal_accounts),
            'sales_invoices': self._extract_all_paged(self.get_sales_invoices, None, since_date),
            'purchase_invoices': self._extract_all_paged(self.get_purchase_invoices, None, since_date),
            'payments': self._extract_all_paged(self.get_payments, None, since_date)
        }
        
        total_records = sum(len(records) for records in all_data.values())
        self.logger.info(f"Extracted {total_records} total records from SAGE")
        
        return all_data
    
    def _extract_all_paged(self, fetch_func, modified_since=None, from_date=None):
        """Helper to extract all pages of data."""
        all_records = []
        offset = 0
        limit = 100
        
        while True:
            kwargs = {'limit': limit, 'offset': offset}
            if modified_since:
                kwargs['modified_since'] = modified_since
            if from_date:
                kwargs['from_date'] = from_date
            
            try:
                records = fetch_func(**kwargs)
                if not records:
                    break
                
                all_records.extend(records)
                offset += limit
                
                if len(records) < limit:
                    # Last page
                    break
                    
            except Exception as e:
                self.logger.error(f"Error fetching paged data: {e}")
                break
        
        return all_records
    
    # ===================================================================
    # UTILITY METHODS
    # ===================================================================
    
    def test_connection(self) -> bool:
        """
        Test SAGE API connection.
        
        Returns:
            True if connection successful, False otherwise
        """
        try:
            # Try to fetch one customer to test connection
            self.get_customers(limit=1)
            self.logger.info("✓ SAGE API connection successful")
            return True
        except Exception as e:
            self.logger.error(f"✗ SAGE API connection failed: {e}")
            return False
    
    def get_company_info(self) -> Dict:
        """Get SAGE company information."""
        try:
            data = self._request('GET', 'company')
            return data.get('data', {})
        except Exception as e:
            self.logger.error(f"Error getting company info: {e}")
            return {}


if __name__ == "__main__":
    # Example usage
    logging.basicConfig(level=logging.INFO)
    
    client = SAGEClient()
    
    # Test connection
    if client.test_connection():
        # Extract all data (1 year)
        data = client.extract_all_data(years_of_data=1)
        print(f"Extracted {sum(len(v) for v in data.values())} total records")

