/**
 * Jobs Page with Server-Sent Events
 * Generated by FrontendAgent
 */

import { useState, useEffect } from "react";
import { NextPage } from "next";
import axios from "axios";

interface Job {
  id: string;
  type: string;
  status: string;
  progress: number;
  created_at: string;
}

const JobsPage: NextPage = () => {
  const [jobs, setJobs] = useState<Job[]>([]);
  const [eventSource, setEventSource] = useState<EventSource | null>(null);

  useEffect(() => {
    loadJobs();
    connectSSE();
    
    return () => {
      if (eventSource) {
        eventSource.close();
      }
    };
  }, []);

  const loadJobs = async () => {
    try {
      const response = await axios.get("/api/ops/jobs");
      setJobs(response.data.jobs || []);
    } catch (err) {
      console.error("Failed to load jobs:", err);
    }
  };

  const connectSSE = async () => {
    try {
      // Get SSE token
      const tokenResponse = await axios.get("/api/sse/token");
      const token = tokenResponse.data.token;

      const es = new EventSource(`/api/ops/stream?token=${token}`);
      
      es.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "job_update") {
          setJobs((prev) => {
            const index = prev.findIndex((j) => j.id === data.job.id);
            if (index >= 0) {
              const updated = [...prev];
              updated[index] = data.job;
              return updated;
            }
            return [...prev, data.job];
          });
        }
      };

      es.onerror = () => {
        console.error("SSE connection error");
        setTimeout(connectSSE, 5000); // Reconnect after 5 seconds
      };

      setEventSource(es);
    } catch (err) {
      console.error("Failed to connect SSE:", err);
    }
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">Jobs</h1>

      <div className="bg-white shadow-md rounded-lg p-6">
        {jobs.length === 0 ? (
          <p className="text-gray-500">No jobs yet.</p>
        ) : (
          <div className="space-y-4">
            {jobs.map((job) => (
              <div key={job.id} className="border rounded p-4">
                <div className="flex justify-between items-center mb-2">
                  <div>
                    <span className="font-semibold">{job.type}</span>
                    <span className={`ml-4 px-2 py-1 rounded text-sm ${
                      job.status === "completed" ? "bg-green-100 text-green-800" :
                      job.status === "failed" ? "bg-red-100 text-red-800" :
                      "bg-blue-100 text-blue-800"
                    }`}>
                      {job.status}
                    </span>
                  </div>
                  <div className="text-sm text-gray-500">{job.created_at}</div>
                </div>
                {job.status === "in_progress" && (
                  <div className="w-full bg-gray-200 rounded-full h-2.5">
                    <div
                      className="bg-blue-600 h-2.5 rounded-full"
                      style={{ width: `${job.progress}%` }}
                    />
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default JobsPage;

